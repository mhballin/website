---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { projects, type ProjectCategory } from "../../../data/projects";
import { enrichProjectsWithImageDimensions } from "../../../lib/enrichProjects.mjs";
import ProjectDetail from "../../../components/ProjectDetail.astro";

const enrichedProjects = await enrichProjectsWithImageDimensions(projects);

export async function getStaticPaths() {
  const enrichedProjects = await enrichProjectsWithImageDimensions(projects);
  return enrichedProjects.flatMap((project) =>
    [project.category as ProjectCategory].flatMap((category) => {
      const canonical = project.slug ?? project.id;
      const ids = project.slug ? [canonical, project.id] : [canonical];
      return ids.map((projectId) => ({
        params: { category, projectId },
        props: { project, category },
      }));
    })
  );
}

interface Props {
  project: (typeof projects)[0];
  category: ProjectCategory;
}

const { project, category } = Astro.props;

// Validate that project matches category
if (project.category !== category) {
  return Astro.redirect(`/work/${project.category}/${project.id}`);
}

const canonical = project.slug ?? project.id;
if (Astro.params.projectId !== canonical) {
  return Astro.redirect(`/work/${category}/${canonical}`, 301);
}

// Generate meta description from project overview or description
const metaDescription = project.overview || project.description;
---

<BaseLayout
  title={project.title}
  description={metaDescription}
  image={project.heroImage}
  sideBarActiveItemID="work"
>
  <ProjectDetail project={project} category={category} />
</BaseLayout>

